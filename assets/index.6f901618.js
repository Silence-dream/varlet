import{F as re,u as ie}from"./provide.315324c1.js";import{I as de}from"./index.520d7afd.js";import{P as ue}from"./index.11644729.js";import{I as ce}from"./index.344a62b4.js";import{R as me}from"./index.e49719fd.js";import{d as pe,r as D,f as O,E as ve,_ as fe,B as U,H as ge,i as A,j as ye,o as m,c as p,a as b,F as he,q as Ve,l as q,z as r,t as be,ad as we,m as w,k as R,n as Re,V as Pe,p as Ce}from"./elevation.4b2b848a.js";import{d as Be,a as v,C as G,D as J,c as ke,i as Fe,g as K,t as Q}from"./components.21c4ed88.js";const Se={modelValue:{type:Array,default:()=>[]},accept:{type:String,default:"image/*"},capture:{type:[String,Boolean],default:void 0},multiple:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},removable:{type:Boolean,default:!0},maxlength:{type:[Number,String]},maxsize:{type:[Number,String]},previewed:{type:Boolean,default:!0},ripple:{type:Boolean,default:!0},validateTrigger:{type:Array,default:()=>["onChange","onRemove"]},rules:{type:Array},hideList:{type:Boolean,default:!1},onBeforeRead:{type:Function},onAfterRead:{type:Function},onBeforeRemove:{type:Function},onRemove:{type:Function},onOversize:{type:Function},"onUpdate:modelValue":{type:Function}};const{n:$e,classes:De}=ke("uploader");let Ue=0;const Ae=pe({name:"VarUploader",directives:{Ripple:me},components:{VarIcon:de,VarPopup:ue,VarFormDetails:re},props:Se,setup(e){const d=D(null),P=D(!1),C=D(null),T=O(()=>{const{maxlength:a,modelValue:{length:s}}=e;return Fe(a)?`${s} / ${a}`:""}),{form:n,bindForm:y}=ie(),{errorMessage:B,validateWithTrigger:k,validate:h,resetValidation:l}=Be(),f=O(()=>{const{modelValue:a,hideList:s}=e;return s?[]:a}),X=()=>{d.value.click()},Y=a=>{const{disabled:s,readonly:t,previewed:o}=e;if((n==null?void 0:n.disabled.value)||(n==null?void 0:n.readonly.value)||s||t||!o)return;const{url:i}=a;if(K(i)&&J(i)){ce(i);return}K(i)&&G(i)&&(C.value=a,P.value=!0)},Z=a=>({id:Ue++,url:"",cover:"",name:a.name,file:a}),_=a=>{const s=a.target,{files:t}=s;return Array.from(t)},x=a=>new Promise(s=>{const t=new FileReader;t.onload=()=>{const o=t.result;a.file.type.startsWith("image")&&(a.cover=o),a.url=o,s(a)},t.readAsDataURL(a.file)}),ee=a=>a.map(x),ae=a=>{const{onBeforeRead:s}=e;return a.map(t=>new Promise(o=>{const i=s?s(U(t)):!0;Promise.resolve(i).then(g=>o({valid:g,varFile:t}))}))},le=async a=>{const{maxsize:s,maxlength:t,modelValue:o,onOversize:i,onAfterRead:g,readonly:S,disabled:$}=e;if((n==null?void 0:n.disabled.value)||(n==null?void 0:n.readonly.value)||$||S)return;const se=u=>u.filter(V=>V.file.size>Q(s)?(v(i,U(V)),!1):!0),te=u=>{const V=Math.min(u.length,Q(t)-o.length);return u.slice(0,V)};let c=_(a).map(Z);c=s!=null?se(c):c,c=t!=null?te(c):c;const oe=await Promise.all(ee(c)),j=(await Promise.all(ae(oe))).filter(({valid:u})=>u).map(({varFile:u})=>u);v(e["onUpdate:modelValue"],[...o,...j]),a.target.value="",j.forEach(u=>v(g,U(u)))},ne=async a=>{const{disabled:s,readonly:t,modelValue:o,onBeforeRemove:i,onRemove:g}=e;if((n==null?void 0:n.disabled.value)||(n==null?void 0:n.readonly.value)||s||t||i&&!await i(a))return;const S=o.filter($=>$!==a);v(g,a),E("onRemove"),v(e["onUpdate:modelValue"],S)},z=()=>e.modelValue.filter(a=>a.state==="success"),N=()=>e.modelValue.filter(a=>a.state==="error"),M=()=>e.modelValue.filter(a=>a.state==="loading"),I={getSuccess:z,getError:N,getLoading:M},E=a=>{ge(()=>{const{validateTrigger:s,rules:t,modelValue:o}=e;k(s,a,t,o,I)})};let F=!1;const H=()=>h(e.rules,e.modelValue,I),W=()=>{F=!0,v(e["onUpdate:modelValue"],[]),l()};return v(y,{validate:H,resetValidation:l,reset:W}),ve(()=>e.modelValue,()=>{!F&&E("onChange"),F=!1},{deep:!0}),{n:$e,classes:De,input:d,files:f,showPreview:P,currentPreview:C,errorMessage:B,maxlengthText:T,isHTMLSupportVideo:G,isHTMLSupportImage:J,formDisabled:n==null?void 0:n.disabled,formReadonly:n==null?void 0:n.readonly,preview:Y,triggerAction:X,handleChange:le,handleRemove:ne,getSuccess:z,getError:N,getLoading:M,validate:H,resetValidation:l,reset:W}}}),Le=["onClick"],Te=["onClick"],ze=["src","alt"],Ne=["multiple","accept","capture","disabled"],Me=["src"];function Ie(e,d,P,C,T,n){const y=A("var-icon"),B=A("var-form-details"),k=A("var-popup"),h=ye("ripple");return m(),p("div",{class:r(e.classes(e.n(),"var--box"))},[b("div",{class:r(e.n("file-list"))},[(m(!0),p(he,null,Ve(e.files,l=>q((m(),p("div",{class:r(e.classes(e.n("file"),"var-elevation--2",[l.state==="loading",e.n("--loading")])),key:l.id,onClick:f=>e.preview(l)},[b("div",{class:r(e.n("file-name"))},be(l.name||l.url),3),e.removable?(m(),p("div",{key:0,class:r(e.n("file-close")),onClick:we(f=>e.handleRemove(l),["stop"])},[w(y,{class:r(e.n("file-close-icon")),"var-uploader-cover":"",name:"delete"},null,8,["class"])],10,Te)):R("v-if",!0),l.cover?(m(),p("img",{key:1,class:r(e.n("file-cover")),style:Re({objectFit:l.fit}),src:l.cover,alt:l.name},null,14,ze)):R("v-if",!0),b("div",{class:r(e.classes(e.n("file-indicator"),[l.state==="success",e.n("--success")],[l.state==="error",e.n("--error")]))},null,2)],10,Le)),[[h,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple}]])),128)),!e.maxlength||e.modelValue.length<e.maxlength?q((m(),p("div",{key:0,class:r(e.classes([!e.$slots.default,`${e.n("action")} var-elevation--2`],[e.disabled||e.formDisabled,e.n("--disabled")])),onClick:d[1]||(d[1]=(...l)=>e.triggerAction&&e.triggerAction(...l))},[b("input",{ref:"input",class:r(e.n("action-input")),type:"file",multiple:e.multiple,accept:e.accept,capture:e.capture,disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly,onChange:d[0]||(d[0]=(...l)=>e.handleChange&&e.handleChange(...l))},null,42,Ne),Pe(e.$slots,"default",{},()=>[w(y,{class:r(e.n("action-icon")),"var-uploader-cover":"",name:"plus"},null,8,["class"])])],2)),[[h,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple||e.$slots.default}]]):R("v-if",!0)],2),w(B,{"error-message":e.errorMessage,"maxlength-text":e.maxlengthText},null,8,["error-message","maxlength-text"]),w(k,{class:r(e.n("preview")),"var-uploader-cover":"",position:"center",show:e.showPreview,"onUpdate:show":d[2]||(d[2]=l=>e.showPreview=l),onClosed:d[3]||(d[3]=l=>e.currentPreview=null)},{default:Ce(()=>{var l,f;return[e.currentPreview&&e.isHTMLSupportVideo((l=e.currentPreview)==null?void 0:l.url)?(m(),p("video",{key:0,class:r(e.n("preview-video")),playsinline:"true","webkit-playsinline":"true","x5-playsinline":"true","x5-video-player-type":"h5","x5-video-player-fullscreen":"false",controls:"",src:(f=e.currentPreview)==null?void 0:f.url},null,10,Me)):R("v-if",!0)]}),_:1},8,["class","show"])],2)}var L=fe(Ae,[["render",Ie]]);L.install=function(e){e.component(L.name,L)};export{L as U};
